<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Goingtesla</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.1/mapbox-gl.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    #map .mapboxgl-ctrl {
      opacity: 0.8;
    }

    #map .mapboxgl-ctrl-group > button {
      width:60px;
      height:60px;
    }

    #map .mapboxgl-ctrl-icon.mapboxgl-ctrl-compass > .mapboxgl-ctrl-compass-arrow  {
      width:40px;
      height:40px;
    }

    #map .mapboxgl-ctrl-top-left .mapboxgl-ctrl {
      width: 400px;
      min-width: 400px;
      max-width:400px;
    }

    #map .mapboxgl-ctrl-icon.mapboxgl-ctrl-autozoom > .mapboxgl-ctrl-autozoom-icon {
      width: 40px;
      height: 40px;
      margin: 5px;
      background-image: url("https://img.icons8.com/small/40/333333/gps-device.png");
      background-repeat: no-repeat;
      display: inline-block;
    }

    #map .mapboxgl-ctrl-geocoder .suggestions {
      font: 20px/1.4 'Gotham Light', 'Verdana', 'Source Sans Pro', 'Helvetica Neue', Sans-serif;5
    }

    #map .mapboxgl-ctrl-geocoder--input {
      font:700 20px/1.15 'Gotham Light', 'Verdana', 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      height: 60px;
    }
    #map .mapboxgl-ctrl-geocoder--icon {
      top: 18px !important;
      left: 5px !important;
      width: 25px !important;
      height: 25px !important;
    }
    #map .mapboxgl-ctrl-geocoder--icon-close {
      margin-top:11px !important;
    }

    .mapboxgl-popup {
      padding-bottom: 25px;
    }
    .mapboxgl-popup-anchor-bottom > .mapboxgl-popup-tip {
      border-top-color: #0d0d0b;
    }
    .mapboxgl-popup-anchor-top > .mapboxgl-popup-tip {
      border-bottom-color: #0d0d0b;
    }
    .mapboxgl-popup-anchor-left > .mapboxgl-popup-tip {
      border-right-color: #0d0d0b;
    }
    .mapboxgl-popup-anchor-right > .mapboxgl-popup-tip {
      border-left-color: #0d0d0b;
    }
    .mapboxgl-popup-close-button {
      display:none;
    }

    .mapboxgl-popup-content {
      font:700 20px/1.15 'Gotham Light', 'Verdana', 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      /*  font:400 25px/1.15 'Source Sans Pro', 'Helvetica Neue', Sans-serif; */
      padding:40px;
      border-radius:10px 10px 10px 10px;
      width:420px;
      background:#191a1a;
      color:#9c9c9c;
    }
    .mapboxgl-popup-content a {
      color:#9c9c9c;
    }
    .mapboxgl-popup-content strong {
      font:700 20px/1.15 'Gotham Medium', 'Verdana', 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      color:#e6e6e6;
    }

    .mapboxgl-popup-content hr {
      height: 1px ;
      border-width: 1px 0 0 0 ;
      border-top: 1px solid gray ;
    }

    .mapboxgl-popup-content-wrapper {
      padding:1%;
    }

    .mapboxgl-popup-content div {
      padding:10px;
    }

    .popupbutton {
      display: inline-block; border-radius: 10px; background:#9c9c9c; color:#000000!important; padding: 18px; width: 100%; box-sizing: border-box;
    }

    /* .mapboxgl-container .leaflet-marker-icon {
      cursor:pointer;
    } */

    .info-container {
      position: absolute;
      top: 20px;
      right: 100px;
      z-index: 1;
    }

    .info-container > * {
      background-color: rgba(0, 0, 0, 0.5);
      font:700 20px/1.15 'Gotham Medium', 'Verdana', 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      color:#e6e6e6;
      display: block;
      margin: 0;
      padding: 10px 20px;
      border-radius:10px 10px 10px 10px;
    }

  </style>
</head>
<body>

  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css' type='text/css' />
  <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>

  <div id='map'></div>
  <div id='info' class='info-container'></div>
  <script>
    if (location.hostname == 'goingtesla.herokuapp.com' && location.protocol !== 'https:') {location.protocol = 'https:'; throw new Error('Changing to secure connection');};

    console.log("App started");

    const goingelectricToken = '5471b3bae96a68bbf90cad00834fb10e';
    const compatiblePlugs = 'CCS,Tesla Supercharger,Tesla Supercharger CCS,Typ2';

    const chargerBigSize = '44';
    const chargerParkSize = '34';
    const chargerFaultSize = '24';

    const chargerTeslaColor = "ff514a";
    // const chargerThirdColor = "4b535a"; // dark marker for light map
    const chargerThirdColor = "787878"; // light marker for dark map
    const chargerParkColor = "e6e6e6"; // light marker for dark map
    const chargerFaultColor = "ffb800";

    const superCharger = {'minPower':'100', 'minZoom':null, 'toggle':2}
    const highwayCharger = {'minPower':'50', 'minZoom':11, 'toggle':2}
    const destinationCharger = {'minPower':'11', 'minZoom':14, 'toggle':1}

    var minPower = superCharger.minPower;

    const slowSpeed = 30;
    const highSpeed = 100;
    const slowSpeedZoom = '16';
    const highSpeedZoom = '9';

    const updatePositionInterval = 20000;

    var zoomToogle = [
      {name:'AutoZoom', zoom:null, autoZoom:true, autoFollow:true, headUp:true, icon:'url("https://img.icons8.com/small/40/333333/gps-device.png"'},
      {name:'DestinationCharger', zoom:slowSpeedZoom, autoZoom:false, autoFollow:true, headUp:false, icon:'url("https://img.icons8.com/ios-glyphs/40/333333/park-and-charge.png"'},
      {name:'SuperCharger', zoom:highSpeedZoom, autoZoom:false, autoFollow:true, headUp:false, icon:'url("https://img.icons8.com/material-sharp/40/333333/tesla-supercharger-pin--v1.png"'}
    ];
    var zoomToggleState = 0;

    var teslaConnection = {'accessToken': getCookie('access'),'refreshToken': getCookie('refresh'), 'vehicle': getCookie('vehicle'), 'status': 'undefined' };
    var teslaPosition = {'longitude' : 10.416667, 'latitude' : 51.133333, 'heading': 0, 'speed' : 100, 'zoom': 9};

    const positionSize = '44';
    var positionColor = 'ff514a';

    var autoZoom = true;
    var autoFollow = true;
    var headUp = true;
    const m = (highSpeedZoom - slowSpeedZoom) / (highSpeed - slowSpeed);
    const b = slowSpeedZoom - m * slowSpeed;

    var infoContainer = document.getElementById('info');

    console.log('Establish Connection to Tesla');
    try {connectTesla ()}
    catch {console.log('Tesla not reachable')};

    var positionIcon = {
      type: 'Feature',
      properties: {'bearing': teslaPosition.heading},
      geometry: {
        type: 'Point',
        coordinates: [teslaPosition.longitude,teslaPosition.latitude]
      }
    };
    zoomToPower(teslaPosition.zoom);

    mapboxgl.accessToken = 'pk.eyJ1Ijoia3JpbGxsZSIsImEiOiJjazBlYWc5OTMwOGhrM2tsY2pxcmgyYzVtIn0.0novoDiTaGPwZ5tPMDDl1A';
    var map = new mapboxgl.Map({
      container: 'map', // container id
      // style: 'mapbox://styles/krillle/ck0my3cjp4nfm1cksdx1rap0q?optimize=true', // Light Tesla
      style: 'mapbox://styles/krillle/ck1fdx1ok208r1drsdxwqur5f?optimize=true', // Dark Tesla
      center: [teslaPosition.longitude,teslaPosition.latitude], // starting position
      zoom: teslaPosition.zoom, // starting zoom
      bearing: teslaPosition.heading,
      attributionControl: false
    });

    // Add geocoder search field
    map.addControl(new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl
    }),'top-left');

    // Add zoom and rotation controls to the map.
    var comp = new mapboxgl.NavigationControl({
      showCompass: true,
      showZoom: false,
      visualizePitch: true
    });
    comp._compass.addEventListener('click', () => {infoMessage('Norden oben'); stopHeadUp()});
    map.addControl(comp);

    var zoom = new mapboxgl.NavigationControl({
      showCompass: false,
      showZoom: true,
      visualizePitch: false
    });
    zoom._zoomInButton.addEventListener('click', () => stopAutoZoom());
    zoom._zoomOutButton.addEventListener('click', () => stopAutoZoom());
    map.addControl(zoom);

    var nav = new mapboxgl.NavigationControl({
      showCompass: false,
      showZoom: false,
      visualizePitch: false
    })
    nav._toggle = nav._createButton('mapboxgl-ctrl-icon mapboxgl-ctrl-autozoom', 'Toggle Autozoom', () => toggleAutoZoom());
    const el = window.document.createElement('span');
    el.className = 'mapboxgl-ctrl-autozoom-icon';
    nav._icon = nav._toggle.appendChild(el);
    map.addControl(nav, 'bottom-right');

    // Add geolocate control to the map.
    const geolocate = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      fitBoundsOptions: {
        maxZoom: 9
      }
    })
    map.addControl(geolocate, 'bottom-right');
    // geolocate.trigger();
    // map.setPitch(30);


    map.on('load', function() {
      // Create Position Image
      map.addSource('positionIcon', { 'type': 'geojson', 'data': positionIcon });

      map.loadImage(`https://img.icons8.com/small/${positionSize}/${positionColor}/gps-device.png`, function(error, image) {
        if (error) throw error;
        map.addImage('position', image);

        /* Style layer: A style layer ties together the source and image and specifies how they are displayed on the map. */
        map.addLayer({
          id: "position",
          type: "symbol",
          /* Source: A data source specifies the geographic coordinate where the image marker gets placed. */
          source: 'positionIcon',
          layout: {
            "icon-image": "position",
            "icon-rotate": ["get", "bearing"],
            "icon-rotation-alignment": "map",
            "icon-allow-overlap": true,
            "icon-ignore-placement": true
          }
        });
      });

      // Create Tesla Supercharger Image
      map.loadImage(`https://img.icons8.com/material-sharp/${chargerBigSize}/${chargerTeslaColor}/tesla-supercharger-pin--v1.png`, function(error, image) {
        if (error) throw error;
        map.addImage('teslaSuperCharger', image);
      });

      // Create Third Party Supercharger Image
      map.loadImage(`https://img.icons8.com/material-sharp/${chargerBigSize}/${chargerThirdColor}/tesla-supercharger-pin--v1.png`, function(error, image) {
        if (error) throw error;
        map.addImage('thirdSuperCharger', image);
      });

      // Create Park Charger Image
      map.loadImage(`https://img.icons8.com/ios-glyphs/${chargerParkSize}/${chargerParkColor}/park-and-charge.png`, function(error, image) {
        if (error) throw error;
        map.addImage('parkCharger', image);
      });

      // Create Fault Report Image
      map.loadImage(`https://img.icons8.com/ios-glyphs/${chargerFaultSize}/${chargerFaultColor}/error.png`, function(error, image) {
        if (error) throw error;
        map.addImage('faultReport', image);
      });

      // Prepare empty Charger Layer
      map.addSource('chargers', {
        "type": "geojson",
        "data": {
          "type": "FeatureCollection",
          "features": []
        }
      });
      map.addLayer({
        "id": "chargers",
        "type": "symbol",
        "source": "chargers",
        "layout": {
           "icon-image": "{icon}",
           "icon-anchor": "bottom"

           // "icon-allow-overlap": true
          // "icon-size": 0.25

          // "text-field": ["get", "status"],
          // "text-variable-anchor": ["top"],
          // "text-radial-offset": 1.5,
          // "text-justify": "auto",
        }
      });

      console.log("Initalize Chargers");
      updateChargers();

    });

    // Events to disable AutoZoom
    map.on('touchstart', function() {
    });

    map.on('mousedown', function() {
    });

    map.on('dragstart', function() {
      stopHeadUp();
      stopAutoZoom();
      console.log("AutoFollow stopped");
      autoFollow = false;
    });

    map.on('rotateend', function() {
      console.log("Rotate End");
    });

    // Events to update chargers
    map.on('moveend', function() {
      console.log("Move End: Invoke Update");
      updateChargers();
    });

    map.on('zoomend', function() {
      console.log("Zoom End: Set Charger for zoom level " + map.getZoom());
      zoomToPower(map.getZoom());
    });

    // map.on('idle', function() {
    //   console.log('Map idle');
    //   infoMessage('Map idle');
    // });


    // Charger places events (Popup)
    map.on('click', 'chargers', function (e) {
      stopAutoZoom();
      stopHeadUp();
      console.log("AutoFollow stopped");
      autoFollow = false;

      var coordinates = e.features[0].geometry.coordinates.slice();
      map.flyTo({ 'center': e.features[0].geometry.coordinates});

      chargerID = e.features[0].id
      var popup = new mapboxgl.Popup({ offset: 25, anchor: 'bottom' })
      map.once('idle', function(e) {
        console.log('Map idle',chargerID);
        popup.setHTML(chargerDescription(chargerID).text)
      });
      popup.setLngLat(coordinates)
      .setHTML(chargerShortDescription(e.features[0].properties).text)
      .addTo(map);
    });

    // Change the cursor to a pointer when the mouse is over the places layer
    map.on('mouseenter', 'chargers', function () {
      map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves
    map.on('mouseleave', 'chargers', function () {
      map.getCanvas().style.cursor = '';
    });

    function toggleAutoZoom() {
      zoomToggleState = zoomToggleState < 2 ? ++zoomToggleState : 0;

      console.log(`${zoomToogle[zoomToggleState].name}: Zoom ${zoomToogle[zoomToggleState].zoom}, AutoZoom ${zoomToogle[zoomToggleState].autoZoom}, AutoFollow ${zoomToogle[zoomToggleState].autoFollow}, HeadUp ${zoomToogle[zoomToggleState].headUp} `);

      updateZoomIcon();
      autoZoom = zoomToogle[zoomToggleState].autoZoom;
      autoFollow = zoomToogle[zoomToggleState].autoFollow;
      headUp = zoomToogle[zoomToggleState].headUp;

      if (zoomToogle[zoomToggleState].zoom) {
        map.jumpTo({ 'zoom': zoomToogle[zoomToggleState].zoom });
      } else {
        infoMessage('Autozoom aktiviert')
        updateMapFocus();
      }
    };

    function stopAutoZoom() {
      if (autoZoom) {
        console.log('AutoZoom stopped');
        infoMessage('Autozoom deaktiviert');
        autoZoom = false;
        updateZoomIcon();
      };
    };

    function stopHeadUp() {
      console.log("HeadUp stopped");
      headUp = false;
    };

    function updateZoomIcon() {
      nav._icon.style['background-image'] = zoomToogle[zoomToggleState].icon;
    };

    function updateMapFocus() {
      var jumpTarget = {};
      if (autoFollow) {jumpTarget.center = [teslaPosition.longitude,teslaPosition.latitude]};
      if (autoZoom) {jumpTarget.zoom = teslaPosition.zoom};
      if (headUp) {jumpTarget.bearing = teslaPosition.heading};
      if (autoFollow || autoZoom || headUp) {
        map.jumpTo(jumpTarget);
        // map.jumpTo({ 'center': [teslaPosition.longitude,teslaPosition.latitude], 'zoom': teslaPosition.zoom, 'bearing': teslaPosition.heading });
      };
    };

    function zoomToPower(zoom) {
      if (zoom >= destinationCharger.minZoom) {
        minPower = destinationCharger.minPower;
        zoomToggleState = destinationCharger.toggle;
      } else if (zoom >= highwayCharger.minZoom) {
        minPower = highwayCharger.minPower;
        zoomToggleState = highwayCharger.toggle;
      } else {
        minPower = superCharger.minPower;
        zoomToggleState = superCharger.toggle;
      }
      if (!autoZoom) {nav._icon.style['background-image'] = zoomToogle[zoomToggleState].icon};
    };

    function milesToKm(miles) {
        var km = parseFloat(miles) * 1.61;
        return {
          'km': km.toFixed().toString().replace(".",",")  + ' km',
          'kmRaw': km
        }
    };

    function secondsToTime(totalSeconds) {
      var hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      var minutes = Math.floor(totalSeconds / 60);
      return ((hours > 0) ? hours + '   Std ' : '') + minutes + ' Min';
    };

    function httpGet(url, token) {
      var httpReq = new XMLHttpRequest();
      httpReq.open('GET', url, false);
      if (token) {httpReq.setRequestHeader('authorization','bearer ' + teslaConnection.accessToken)};
      httpReq.send(null);
      // console.log("Result: " + httpReq.responseText);
      return httpReq.responseText;
    };

    function getCookie(name) {
      var value = "; " + document.cookie;
      var parts = value.split("; " + name + "=");
      if (parts.length == 2) return parts.pop().split(";").shift();
    };


    function settingsPopup () {
      // var popup = new mapboxgl.Popup({closeOnClick: false})
      // .setLngLat(map.getCenter())
      // .setHTML(settingsContent())
      // .addTo(map);
      //
      // document.getElementById('connect').addEventListener('click', createTeslaToken(document.getElementById("email").value, document.getElementById("password").value));
      //
      // document.querySelector('status').textContent = teslaConnection.status;

      var email = prompt('Verbindungsstatus: ' + teslaConnection.status + '\rBitte Tesla-Account E-Mail eingeben');
      var password = prompt("Bitte Passwort für diesen Tesla-Account eingeben");

      createTeslaToken(email, password);
    };

    function infoMessage(message) {
      if (infoContainer.innerHTML) {infoContainer.innerHTML = '';};
      var pre = document.createElement('pre');
      pre.textContent = message;
      infoContainer.appendChild(pre);
      setTimeout(function(){ infoContainer.innerHTML = ''; }, 3000);
    };

    // Tesla connection - - - - - -

    function connectTesla () {
      // document.cookie = "access=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"; //  Cookie löschen
      console.log ('Access cookie: ' + getCookie('access'));
      console.log ('Access data: ' + teslaConnection.accessToken);

      if (typeof(teslaConnection.accessToken) == 'undefined') {
        teslaConnection.status = 'Kein Token';
        console.log(teslaConnection.status);
        infoMessage(teslaConnection.status);
        settingsPopup ();
        return;
      };

      var vehicleData = getTeslaCarData();
      console.log(vehicleData);
      if (vehicleData == null) {
        teslaConnection.status = 'Ungültiges Token';
        console.log(teslaConnection.status);
        infoMessage(teslaConnection.status);
        settingsPopup ();
        return;

      } else if (vehicleData.response == null) {
        // Car sleeps
        teslaConnection.status = 'Fahrzeug nicht erreichbar';
        console.log(teslaConnection.status);
        infoMessage(teslaConnection.status);
        return;
      }
      else {
        teslaConnection.status = 'Verbunden mit ' + vehicleData.response.vehicle_state.vehicle_name;
        console.log(teslaConnection.status);
        infoMessage(teslaConnection.status);
        setTeslaPosition(vehicleData.response.drive_state);
        console.log ('Starting continous update');
        setInterval(updatePosition, updatePositionInterval);
      };
    };

    function setTeslaPosition(driveStatus) {
      var zoom = ((driveStatus.speed) ? driveStatus.speed : 0) * m + b;
      zoom = (zoom > slowSpeedZoom) ? slowSpeedZoom : (zoom < highSpeedZoom) ? highSpeedZoom : zoom;

      teslaPosition = {
        'longitude': driveStatus.longitude,
        'latitude': driveStatus.latitude,
        'heading': driveStatus.heading,
        'speed': (driveStatus.speed) ? driveStatus.speed : 0,
        'zoom': zoom
      };
    };

    function updatePosition() {
      setTeslaPosition(getTeslaDriveStatus().response);

      if (positionIcon.geometry.coordinates != [teslaPosition.longitude,teslaPosition.latitude]
          && positionIcon.properties.bearing != teslaPosition.heading) {
        positionIcon.geometry.coordinates = [teslaPosition.longitude,teslaPosition.latitude];
        positionIcon.properties.bearing = teslaPosition.heading;

        map.getSource('positionIcon').setData(positionIcon);

        updateMapFocus ();
      };
    };

    // - - - - - - - - Tesla requests - - - - - - - - -

    function getTeslaChargeStatus() {
      var teslaUrl = 'https://goingtesla.herokuapp.com/corsproxy.php?'
          + 'csurl=https://owner-api.teslamotors.com/api/1/vehicles/' + teslaConnection.vehicle + '/data_request/charge_state';

      return JSON.parse(httpGet(teslaUrl,true));
    };

    function getTeslaDriveStatus() {
      var teslaUrl = 'https://goingtesla.herokuapp.com/corsproxy.php?'
          + 'csurl=https://owner-api.teslamotors.com/api/1/vehicles/' + teslaConnection.vehicle + '/data_request/drive_state';

      return JSON.parse(httpGet(teslaUrl,true));
    };

    function getTeslaCarData() {
      var teslaUrl = 'https://goingtesla.herokuapp.com/corsproxy.php?'
          + 'csurl=https://owner-api.teslamotors.com/api/1/vehicles/' + teslaConnection.vehicle + '/vehicle_data';

      return JSON.parse(httpGet(teslaUrl,true));
    };

    function getTeslaVehicles() {
      var teslaUrl = 'https://goingtesla.herokuapp.com/corsproxy.php?'
          + 'csurl=https://owner-api.teslamotors.com/api/1/vehicles';

      return JSON.parse(httpGet(teslaUrl,true));
    };

    function createTeslaToken (email, password) {
      var teslaUrl = 'https://goingtesla.herokuapp.com/corsproxy.php?'
      + 'csurl=https://owner-api.teslamotors.com//oauth/token?grant_type=password';

      var body = JSON.stringify({
        "grant_type": "password",
        "client_id": "81527cff06843c8634fdc09e8ac0abefb46ac849f38fe1e431c2ef2106796384",
        "client_secret": "c7257eb71a564034f9419ee651c7d0e5f7aa6bfbd18bafb5c5c033b093bb2fa3",
        "email": email,
        "password": password
      });

      var xhr = new XMLHttpRequest();
      xhr.withCredentials = true;

      xhr.addEventListener("readystatechange", function () {
        if (this.readyState === 4) {
          console.log("GetToken Listener Result: " + this.responseText);
          var result = JSON.parse(this.responseText);
          teslaConnection.accessToken = result.access_token;
          teslaConnection.refreshToken = result.refresh_token;
          // result.expires_in
          // result.created_at

          console.log("Access: " + teslaConnection.accessToken);
          console.log("Refresh: " + teslaConnection.refreshToken);

          teslaConnection.vehicle = getTeslaVehicles().response[0].id_s;
          console.log("Vehicle: " + teslaConnection.vehicle);

          document.cookie = 'access=' + teslaConnection.accessToken + '; expires=Thu, 10 Aug 2022 12:00:00 UTC";';
          document.cookie = 'refresh=' + teslaConnection.refreshToken + '; expires=Thu, 10 Aug 2022 12:00:00 UTC";';
          document.cookie = 'vehicle=' + teslaConnection.vehicle + '; expires=Thu, 10 Aug 2022 12:00:00 UTC";';

          connectTesla();
        }
      });

      xhr.open("POST", teslaUrl);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.setRequestHeader("cache-control", "no-cache");

      xhr.send(body);
    };

    function sendDestinationToTesla(destination) {
      console.log('Set destination: ' + destination);
      var teslaUrl = 'https://goingtesla.herokuapp.com/corsproxy.php?'
      + 'csurl=https://owner-api.teslamotors.com/api/1/vehicles/' + teslaConnection.vehicle + '/command/share';

      var body = JSON.stringify({
        "type": "share_ext_content_raw",
        "value": {
          "android.intent.extra.TEXT": destination
        },
        "locale": "en-US",
        "timestamp_ms": Date.now()
      });

      var xhr = new XMLHttpRequest();
      xhr.withCredentials = true;

      xhr.addEventListener("readystatechange", function () {
        if (this.readyState === 4) {
          console.log('Send destination: ' + this.responseText);
        }
      });

      xhr.open("POST", teslaUrl);

      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.setRequestHeader("Authorization", 'bearer ' + teslaConnection.accessToken);
      xhr.setRequestHeader("cache-control", "no-cache");

      xhr.send(body);

    };

    // mapBox requests
    function getRoute(start,destination){
       var routeUrl = 'https://api.mapbox.com/directions/v5/mapbox/driving/'
          + start.longitude + ',' + start.latitude + ';'
          + destination.lng + ',' + destination.lat
          + '?access_token=' + mapboxgl.accessToken + '&geometries=geojson&overview=false'
      result = httpGet(routeUrl)
      console.log("Result" + result);
      if (result) {
        result = JSON.parse(result);
        if (result.code == "Ok") {
          return {
            'distanceRaw': result.routes[0].distance/1000,
            'distance': (result.routes[0].distance/1000).toFixed(1).toString().replace(".",",")  + ' km',
            'duration': secondsToTime(result.routes[0].duration),
            'durationRaw': result.routes[0].duration
          }
        } else {
          return null
        }
      } else {
        return null;
      };
    };

    // GoingElectric requests
    function getChargerDetails(id) {
      var geUrl = 'https://api.goingelectric.de/chargepoints/?'+
        `key=${goingelectricToken}&`+
        `ge_id=${id}`;
      return JSON.parse(httpGet(geUrl));
    };

    function getChargersInBounds(searchField) {
      var geUrl = 'https://api.goingelectric.de/chargepoints/?'+
        `key=${goingelectricToken}&`+
        `plugs=${compatiblePlugs}&min_power=${minPower}&`+
        `ne_lat=${searchField.getNorthEast().lat}&ne_lng=${searchField.getNorthEast().lng}&`+
        `sw_lat=${searchField.getSouthWest().lat}&sw_lng=${searchField.getSouthWest().lng}`;
      return JSON.parse(httpGet(geUrl));
    };

    function updateChargers() {
      var chargerList = getChargersInBounds(map.getBounds())
      console.log("GE Reply: ", chargerList);
      if (chargerList.status != "ok") {throw "GoingElectric request failed"};
      if (chargerList.startkey == 500) {console.log("More than 500 chargers in area");}

      var newList = {
          "type": "FeatureCollection",
          "features": []
      };
      chargerList.chargelocations.forEach(chargeLocation => {
        var maxPower = 0;
        chargeLocation.chargepoints.forEach(chargePoint => { maxPower = (chargePoint.power > maxPower) ? chargePoint.power : maxPower; });

        newList.features.push({
          "id": chargeLocation.ge_id.toString(),
          "type": "Feature",
          "properties": {
            "icon": (chargeLocation.fault_report) ? "faultReport" :
              (chargeLocation.network.toString().toLowerCase().includes("tesla supercharger")) ? "teslaSuperCharger" :
              (maxPower >= superCharger.minPower) ? "thirdSuperCharger" :
              "parkCharger",

            "coordinates": chargeLocation.coordinates,
            "chargepoints": chargeLocation.chargepoints,
            "name": chargeLocation.name,
            "street": chargeLocation.address.street,
            "city": chargeLocation.address.city,
            "country": chargeLocation.address.country,
            "network": chargeLocation.network,
            "operator": chargeLocation.operator,
            "url": chargeLocation.url
          },
          "geometry": {
            "type": "Point",
            "coordinates": [chargeLocation.coordinates.lng, chargeLocation.coordinates.lat]
          }
        });
      });
      map.getSource('chargers').setData(newList);
    };

    function getMaxChargePoint (chargePoints) {
      var maxPower = 0;
      var maxType = "";
      var maxCount = 0;

      chargePoints.forEach(chargePoint => {
        if (chargePoint.power > maxPower && compatiblePlugs.includes(chargePoint.type)) {
          maxPower = chargePoint.power;
          maxType = chargePoint.type;
          maxCount = chargePoint.count;
        };
      });
      return {'power': maxPower, 'type': maxType, 'count': maxCount};
    };

    function chargerShortDescription (chargeLocation) {
      maxChargePoint = getMaxChargePoint(JSON.parse(chargeLocation.chargepoints));

      var address = `${chargeLocation.street}, ${chargeLocation.city}, ${chargeLocation.country}`;

      var description = '';
      description = `<strong>${chargeLocation.name} ${chargeLocation.city}</strong>`;

      description += (chargeLocation.network && chargeLocation.network != chargeLocation.name && chargeLocation.network != chargeLocation.name + ' ' + chargeLocation.city) ?
                     (`<br>${chargeLocation.network}<p>`) :
                     (chargeLocation.operator && chargeLocation.operator != chargeLocation.name && chargeLocation.operator != chargeLocation.name + ' ' + chargeLocation.city) ?
                     `<br>${chargeLocation.operator}<p>` :
                     '<p>'
                     // <span id='A'></span>;
                     // document.getElementById('A').innerHTML="oijoij"

      description += `${maxChargePoint.count}x ${maxChargePoint.power} kW ${maxChargePoint.type}<p>`;
      description += '<hr>';
      description += `${chargeLocation.street}<br>${chargeLocation.city}<p>`;

      description += `<a href=${chargeLocation.url} target="_blank">Details auf GoingElectric</a><p>`;
      description += `<a href=# onclick='sendDestinationToTesla("${address}");'>Als Navigationsziel setzen</a>`;

      return {'text': description, 'address': address};
    };

    function chargerDescription (id) {
      var chargerDetails = getChargerDetails(id);
      if (chargerDetails.status != "ok") {throw "GoingElectric request failed"};
      var chargeLocation = chargerDetails.chargelocations[0];

      maxChargePoint = getMaxChargePoint(chargeLocation.chargepoints);
      var route = getRoute(teslaPosition,chargeLocation.coordinates);
      var address = `${chargeLocation.address.street}, ${chargeLocation.address.city}, ${chargeLocation.address.country}`;

      var description = '';
      description = `<strong>${chargeLocation.name} ${chargeLocation.address.city}</strong>`;

      description += (chargeLocation.network && chargeLocation.network != chargeLocation.name && chargeLocation.network != chargeLocation.name + ' ' + chargeLocation.address.city) ?
                     (`<br>${chargeLocation.network}<p>`) :
                     (chargeLocation.operator && chargeLocation.operator != chargeLocation.name && chargeLocation.operator != chargeLocation.name + ' ' + chargeLocation.address.city) ?
                     `<br>${chargeLocation.operator}<p>` :
                     '<p>';

      description += `${maxChargePoint.count}x ${maxChargePoint.power} kW ${maxChargePoint.type}<p>`;
      description += (chargeLocation.location_description) ? (`<br>${chargeLocation.location_description}<p>`) : '<p>';
      description += (chargeLocation.fault_report) ? (`<strong>Störung:</strong> ${chargeLocation.fault_report.description}<p>`) : '';
      description += '<hr>';
      // description += (chargeLocation.general_information) ? (`Hinweis: ${chargeLocation.general_information}<br>`) : '';

      description += (chargeLocation.ladeweile) ? (`Ladeweile: ${chargeLocation.ladeweile}<p>`) : '';
      description += `${chargeLocation.address.street}<br>${chargeLocation.address.city}<p>`;

//      description += (route) ? '<strong>' + route.distance +  route.duration : '';
      if (route) {
        description += '<strong>' + route.distance + ', ' + route.duration + '<strong>';
        try {
          description += '<br> Reichweite bei Ankunft ' + (milesToKm(getTeslaChargeStatus().response.est_battery_range).kmRaw - route.distanceRaw).toFixed() + ' km';
      }
        catch {};
        description += '<p>'
      };
      description += `<a href=${chargeLocation.url} target="_blank">Details auf GoingElectric ${id}</a><p>`;
      description += `<a href=# onclick='sendDestinationToTesla("${address}");'>Als Navigationsziel setzen</a>`;

      // description += `<a class= "popupbutton" href=# onclick='sendDestinationToTesla("${address}");'>Als Navigationsziel setzen</a>`;

      return {'text': description, 'address': address};
    };

    // function settingsContent(){
    //   var content = '';
    //   content += '';
    //   content += '<form>';
    //   content += '	<strong>Mit Tesla verbinden</strong><p>';
    //   content += '	<label for="email">E-Mail</label>';
    //   content += '	<input id="email" name="email" type="text" value="" /> <br />';
    //
    //   content += '  <label for="password">Passwort</label>';
    //   content += '	<input id="password" name="password" type="text" value="" /> <br />';
    //
    //   content += '  <button type="button" id="connect">Aktivieren</button><p>';
    //   content += '  Status: <status></status>';
    //   content += '</form>';
    //
    //   return content;
    // };

  </script>

</body>
</html>
